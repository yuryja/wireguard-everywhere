{% extends "layout.html" %}

{% block content %}
<nav>
    <ul>
        <li><a href="{{ url_for('index') }}">{{ _('back_dashboard') }}</a></li>
    </ul>
</nav>

<div class="grid">
    <div>
        <hgroup>
            <h1>{{ client.name }}</h1>
            <h2>{{ _('config_text') }}</h2>
        </hgroup>

        <article>
            <header>{{ _('client_details') }}</header>
            <table role="grid">
                <tr>
                    <th scope="row">{{ _('ip_address') }}</th>
                    <td><code>{{ client.ip_address }}</code></td>
                </tr>
                <tr>
                    <th scope="row">{{ _('public_key') }}</th>
                    <td><small>{{ client.public_key }}</small></td>
                </tr>
                <tr>
                    <th scope="row">{{ _('created_at') }}</th>
                    <td>{{ client.created_at }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('status') }}</th>
                    <td>
                        <span id="status-badge" class="{{ 'status-active' if client.enabled else 'status-inactive' }}" style="display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:5px;"></span>
                        <span id="status-text">{{ _('active') if client.enabled else _('disabled') }}</span>
                    </td>
                </tr>
            </table>
            
            <div class="grid">
                <button id="toggle-btn" 
                        onclick="toggleClient('{{ client.name }}')" 
                        class="{{ 'secondary' if client.enabled else '' }}"
                        data-enable-text="{{ _('enable_client') }}"
                        data-disable-text="{{ _('disable_client') }}"
                        data-status-active="{{ _('active') }}"
                        data-status-disabled="{{ _('disabled') }}">
                    {{ _('disable_client') if client.enabled else _('enable_client') }}
                </button>
                <form action="{{ url_for('delete_client', client_name=client.name) }}" method="post" onsubmit="return confirm('{{ _('confirm_delete') }}');">
                    <button type="submit" class="contrast outline" style="width: 100%;">{{ _('delete_client') }}</button>
                </form>
            </div>
        </article>
    </div>

    <div>
        <article>
            <header>{{ _('qr_code') }}</header>
            <div style="text-align: center;">
                <img src="{{ url_for('client_qr', client_name=client.name) }}" alt="QR Code" style="max-width: 100%; height: auto; border-radius: 8px;">
                <p><small>{{ _('scan_instruction') }}</small></p>
            </div>
            <footer>
                <a href="{{ url_for('download_client_config', client_name=client.name) }}" role="button" style="width: 100%;">{{ _('download_file') }}</a>
            </footer>
        </article>

        <article>
            <header>{{ _('config_text') }}</header>
            <pre style="max-height: 300px; overflow-y: auto;"><code>{{ config_content }}</code></pre>
            <button onclick="copyConfig()" class="outline" style="width: 100%; margin-bottom:0;" data-copied="{{ _('copied') }}">{{ _('copy_clipboard') }}</button>
        </article>
    </div>
</div>

<script>
async function toggleClient(name) {
    const btn = document.getElementById('toggle-btn');
    const badge = document.getElementById('status-badge');
    const text = document.getElementById('status-text');
    
    // Get translations from data attributes
    const enableText = btn.getAttribute('data-enable-text');
    const disableText = btn.getAttribute('data-disable-text');
    const activeText = btn.getAttribute('data-status-active');
    const disabledText = btn.getAttribute('data-status-disabled');
    
    // Disable button during requests
    btn.setAttribute('aria-busy', 'true');
    
    try {
        const response = await fetch(`/clients/${name}/toggle`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            if (data.enabled) {
                btn.textContent = disableText;
                btn.classList.remove('secondary'); 
                badge.classList.remove('status-inactive');
                badge.classList.add('status-active');
                text.textContent = activeText;
            } else {
                btn.textContent = enableText;
                btn.classList.add('secondary'); 
                badge.classList.remove('status-active');
                badge.classList.add('status-inactive');
                text.textContent = disabledText;
            }
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Network error');
    } finally {
        btn.setAttribute('aria-busy', 'false');
    }
}

function copyConfig() {
    const configText = document.querySelector('pre code').innerText;
    const btn = document.querySelector('button[onclick="copyConfig()"]');
    const copiedMsg = btn.getAttribute('data-copied');
    
    navigator.clipboard.writeText(configText).then(() => {
        alert(copiedMsg);
    });
}
</script>
{% endblock %}
