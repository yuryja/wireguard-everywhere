{% extends "layout.html" %}

{% block content %}
<div class="mb-8">
    <a href="{{ url_for('index') }}" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 transition-colors font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
        {{ _('back_dashboard') }}
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column: Details & Actions -->
    <div class="lg:col-span-1 space-y-6">
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">{{ client.name }}</h1>
                    <div class="flex items-center px-3 py-1 rounded-full text-xs font-semibold {{ 'bg-green-100 text-green-700' if client.enabled else 'bg-gray-100 text-gray-600' }}">
                        <span id="status-badge" class="w-2 h-2 rounded-full mr-2 {{ 'bg-green-500' if client.enabled else 'bg-gray-400' }}"></span>
                        <span id="status-text">{{ _('active') if client.enabled else _('disabled') }}</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center py-2 border-b border-gray-50">
                        <span class="text-sm text-gray-500">{{ _('ip_address') }}</span>
                        <code class="text-sm font-bold text-gray-900 bg-gray-50 px-2 py-1 rounded-lg">{{ client.ip_address }}</code>
                    </div>
                    <div class="flex flex-col py-2 border-b border-gray-50">
                        <span class="text-sm text-gray-500 mb-1">{{ _('public_key') }}</span>
                        <code class="text-[10px] break-all text-gray-600 bg-gray-50 p-2 rounded-lg">{{ client.public_key }}</code>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-50">
                        <span class="text-sm text-gray-500">{{ _('created_at') }}</span>
                        <span class="text-sm text-gray-700">{{ client.created_at[:10] }}</span>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button id="toggle-btn" 
                            onclick="toggleClient('{{ client.name }}')" 
                            class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold transition-all transform active:scale-[0.98] {{ 'bg-amber-50 text-amber-700 hover:bg-amber-100' if client.enabled else 'bg-green-600 text-white hover:bg-green-700 shadow-green-100 shadow-lg' }}"
                            data-enable-text="{{ _('enable_client') }}"
                            data-disable-text="{{ _('disable_client') }}"
                            data-status-active="{{ _('active') }}"
                            data-status-disabled="{{ _('disabled') }}">
                        <i data-lucide="{{ 'power-off' if client.enabled else 'power' }}" class="w-4 h-4 mr-2"></i>
                        {{ _('disable_client') if client.enabled else _('enable_client') }}
                    </button>
                    
                    <form action="{{ url_for('delete_client', client_name=client.name) }}" method="post" id="delete-form" data-confirm="{{ _('confirm_delete') }}">
                        <button type="submit" class="w-full flex items-center justify-center py-3 px-4 border border-red-200 rounded-xl text-sm font-bold text-red-600 bg-white hover:bg-red-50 transition-all">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            {{ _('delete_client') }}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="bg-indigo-600 rounded-3xl p-6 shadow-lg shadow-indigo-100 text-white">
            <h3 class="font-bold text-lg mb-4 flex items-center">
                <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                Descargar Configuraci√≥n
            </h3>
            <p class="text-indigo-100 text-sm mb-6">Descarga el archivo <code>.conf</code> para importarlo directamente en tu cliente de WireGuard.</p>
            <a href="{{ url_for('download_client_config', client_name=client.name) }}" class="w-full inline-flex justify-center items-center py-3 px-4 rounded-xl bg-white text-indigo-600 font-bold hover:bg-indigo-50 transition-colors">
                {{ _('download_file') }}
            </a>
        </div>
    </div>

    <!-- Right Column: QR & Raw Config -->
    <div class="lg:col-span-2 space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- QR Code Card -->
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 flex flex-col items-center">
                <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center">
                    <i data-lucide="qr-code" class="w-5 h-5 mr-2 text-indigo-600"></i>
                    {{ _('qr_code') }}
                </h3>
                <div class="bg-gray-50 p-6 rounded-2xl mb-4">
                    <img src="{{ url_for('client_qr', client_name=client.name) }}" alt="QR Code" class="w-48 h-48 mix-blend-multiply">
                </div>
                <p class="text-xs text-center text-gray-500 px-4">{{ _('scan_instruction') }}</p>
            </div>

            <!-- Configuration Preview -->
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 text-indigo-600"></i>
                        {{ _('config_preview') }}
                    </h3>
                    <button onclick="copyConfig()" id="copy-btn" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" data-copied="{{ _('copied') }}">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="flex-1 bg-slate-900 rounded-2xl overflow-hidden">
                    <pre class="p-6 text-indigo-300 font-mono text-xs h-[256px] overflow-auto custom-scrollbar"><code>{{ config_content }}</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
</style>

<script>
async function toggleClient(name) {
    const btn = document.getElementById('toggle-btn');
    const badge = document.getElementById('status-badge');
    const text = document.getElementById('status-text');
    
    const enableText = btn.getAttribute('data-enable-text');
    const disableText = btn.getAttribute('data-disable-text');
    const activeText = btn.getAttribute('data-status-active');
    const disabledText = btn.getAttribute('data-status-disabled');
    
    btn.classList.add('opacity-50', 'pointer-events-none');
    
    try {
        const response = await fetch(`/clients/${name}/toggle`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            if (data.enabled) {
                btn.innerHTML = `<i data-lucide="power-off" class="w-4 h-4 mr-2"></i> ${disableText}`;
                btn.className = "w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold transition-all bg-amber-50 text-amber-700 hover:bg-amber-100";
                badge.className = "w-2 h-2 rounded-full mr-2 bg-green-500";
                text.textContent = activeText;
            } else {
                btn.innerHTML = `<i data-lucide="power" class="w-4 h-4 mr-2"></i> ${enableText}`;
                btn.className = "w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold transition-all bg-green-600 text-white hover:bg-green-700 shadow-green-100 shadow-lg";
                badge.className = "w-2 h-2 rounded-full mr-2 bg-gray-400";
                text.textContent = disabledText;
            }
            lucide.createIcons();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Network error');
    } finally {
        btn.classList.remove('opacity-50', 'pointer-events-none');
    }
}

document.getElementById('delete-form').onsubmit = function() {
    return confirm(this.getAttribute('data-confirm'));
};

function copyConfig() {
    const configText = document.querySelector('pre code').innerText;
    const btn = document.getElementById('copy-btn');
    const copiedMsg = btn.getAttribute('data-copied');
    
    navigator.clipboard.writeText(configText).then(() => {
        const originalIcon = btn.innerHTML;
        btn.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-green-500"></i>`;
        lucide.createIcons();
        setTimeout(() => {
            btn.innerHTML = originalIcon;
            lucide.createIcons();
        }, 2000);
    });
}
</script>
{% endblock %}
